
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Green Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
   on: absolute; bottom: 12px; right: 12px;
      background: #fff; border: 1px solid #ccc; border-radius: 6px;
      padding: 8px 10px; font: 14px/1.4 system-ui, sans-serif;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
    .dot-completed { background:#2e7d32; }
    .dot-working  { background:#f9a825; }
    .dot-inactive { background:#616161; }
    .dot-hold     { background:#6d4c41; }
    .dot-tbu      { background:#0277bd; }
    .dot-data     { background:#283593; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
 wide view)
    const map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // 2) Group your companies by city/state (one marker per city)
    const rows = Array.isArray(window.GREEN_MAP_DATA) ? window.GREEN_MAP_DATA : [];
    const normalize = v => (v || '').trim();
    const cityGroups = new Map();

    rows.forEach(r => {
      const city = normalize(r.city);
      const state = normalize(r.state);
      const key = state ? `${city}, ${state}` : city;
      if (!cityGroups.has(key)) cityGroups.set(key, []);
      cityGroups.get(key).push(r);
    });

    // 3) LocalStorage cache for geocoded city coordinates
    const CACHE_KEY = 'greenMapCityCacheV1';
    const cityCache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
    const saveCache = () => localStorage.setItem(CACHE_KEY, JSON.stringify(cityCache));

    // 4) Nominatim geocoding queue — respect 1 req/sec policy
    const queue = [];
    function enqueue(q){ if (!queue.includes(q)) queue.push(q); }

    async function geocodeOnce(query) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
      try {
        const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
        const json = await r.json();
        if (Array.isArray(json) && json.length) {
          const { lat, lon, display_name } = json[0];
          cityCache[query] = { lat: +lat, lon: +lon, name: display_name };
          saveCache();
          return cityCache[query];
        }
        cityCache[query] = null; saveCache(); return null;
      } catch {
        return null;
      }
    }

    // 5) Marker rendering (one per city; popup lists all companies)
    const statusBadge = s => {
      const x = (s || '').toLowerCase();
      if (x.includes('completed')) return '<span class="status-dot dot-completed"></span>Completed';
      if (x.includes('working'))   return '<span class="status-dot dot-working"></span>Working on Documentation';
      if (x.includes('inactive'))  return '<span class="status-dot dot-inactive"></span>Inactive';
      if (x.includes('hold'))      return '<span class="status-dot dot-hold"></span>On Hold';
      if (x.includes('updated'))   return '<span class="status-dot dot-tbu"></span>To be updated';
      if (x.includes('data'))      return '<span class="status-dot dot-data"></span>Data Received';
      return s || '—';
    };

    function renderCity(query, coords) {
      if (!coords) return;
      const list = cityGroups.get(query) || [];
      const items = list.map(item => {
        const name = item.company || '—';
        const cat  = item.category || '—';
        const stat = statusBadge(item.status);
        const year = item.year || '—';
        const poc  = item.poc || '—';
        const team = item.gp_team || '—';
        return `<li><strong>${name}</strong><br/><small>${cat}</small><br/>${stat}<br/><small>Year: ${year} | PoC: ${poc} | Team: ${team}</small></li>`;
      }).join('');
      const popupHtml = `<div><h3 style="margin:0 0 8px 0">${query}</h3><ol style="padding-left:18px">${items}</ol></div>`;
      const m = L.marker([coords.lat, coords.lon]).addTo(map);
      m.bindPopup(popupHtml);
    }

    // 6) Use cache where available; enqueue the rest
    for (const q of cityGroups.keys()) {
      const cached = cityCache[q];
      if (cached && typeof cached.lat === 'number') renderCity(q, cached);
      else enqueue(q);
    }

    // 7) Process at ~1 req/sec
    const timer = setInterval(async () => {
      if (!queue.length) { clearInterval(timer); return; }
      const q = queue.shift();
      const res = await geocodeOnce(q);
      if (res) renderCity(q, res);
    }, 1100);

    // 8) Legend
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div><strong>The Green Map</strong></div>
        <div>Basemap: OpenStreetMap via Leaflet</div>
        <div style="margin-top:6px">
          <div><span class="status-dot dot-completed"></span>Completed</div>
          <div><span class="status-dot dot-working"></span>Working on Documentation</div>
          <div><span class="status-dot dot-inactive"></span>Inactive</div>
          <div><span class="status-dot dot-hold"></span>On Hold</div>
          <div><span class="status-dot dot-tbu"></span>To be updated</div>
          <div><span class="status-dot dot-data"></span>Data Received</div>
        </div>`;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>