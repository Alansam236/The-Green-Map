
name: Vendor Leaflet assets into docs/assets

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/vendor-leaflet.yml'
      - 'docs/index.html'
      - 'docs/assets/**'
  workflow_dispatch:

jobs:
  vendor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create folders
        run: |
          mkdir -p docs/assets/leaflet/images

      - name: Download Leaflet 1.9.4 (CSS/JS + images) with fallback
        run: |
          set -e
          fetch() { curl -L --fail --retry 3 --retry-delay 2 -o "$1" "$2"; }

          # Primary: jsDelivr
          fetch docs/assets/leaflet/leaflet.css https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css || \
          fetch docs/assets/leaflet/leaflet.css https://unpkg.com/leaflet@1.9.4/dist/leaflet.css

          fetch docs/assets/leaflet/leaflet.js  https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js  || \
          fetch docs/assets/leaflet/leaflet.js  https://unpkg.com/leaflet@1.9.4/dist/leaflet.js

          fetch docs/assets/leaflet/images/marker-icon.png    https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-icon.png    || \
          fetch docs/assets/leaflet/images/marker-icon.png    https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png

          fetch docs/assets/leaflet/images/marker-icon-2x.png https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-icon-2x.png || \
          fetch docs/assets/leaflet/images/marker-icon-2x.png https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png

          fetch docs/assets/leaflet/images/marker-shadow.png  https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-shadow.png  || \
          fetch docs/assets/leaflet/images/marker-shadow.png  https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png

      - name: Commit vendored Leaflet files
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/assets/leaflet/leaflet.css docs/assets/leaflet/leaflet.js docs/assets/leaflet/images/*
          git commit -m "Vendor Leaflet 1.9.4 assets into docs/assets" || echo "No changes"
          git push
