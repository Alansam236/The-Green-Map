
name: Build & Deploy site to gh-pages

on:
  push:
    branches: [ main ]
    paths:
      - 'dataset.xlsx'
      - 'index.html'
      - 'assets/**'
      - 'data.template.js'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install SheetJS (xlsx)
        run: npm install xlsx@0.18.5

      - name: Build static site
        run: |
          mkdir -p dist/assets/leaflet/images
          # Copy your local Leaflet assets and index.html
          cp -r assets dist/assets
          cp index.html dist/index.html

          # Create data.js by combining template + rows from dataset.xlsx
          node - <<'EOF'
          const fs = require('fs');
          const XLSX = require('xlsx');

          // Read Excel (on main; not published)
          const wb = XLSX.readFile('dataset.xlsx');
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

          // Read template with colors + geo cache
          const template = fs.readFileSync('data.template.js', 'utf8');

          // Append DATA_ROWS
          const out = template + '\n\nconst DATA_ROWS = ' + JSON.stringify(rows, null, 2) + ';\n';
          fs.writeFileSync('dist/data.js', out, 'utf8');
          console.log('Built data.js with', rows.length, 'rows');
          EOF

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
