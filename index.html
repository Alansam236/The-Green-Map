<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>India Supplier Map (Excel-driven)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Leaflet CSS -->
  https://unpkg.com/leaflet@1.9.4/dist/leaflet.css
  <!-- SheetJS (xlsx) -->
  https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js</script>
  <style>
    html, body { height: 100%; margin: 0; }
    #toolbar {
      display: grid; gap: .5rem; grid-template-columns: repeat(4, minmax(160px, 1fr));
      padding: .75rem; border-bottom: 1px solid #eee; font-family: system-ui, sans-serif;
    }
    #map { height: calc(100% - 64px); }
    .legend { background: white; padding: .5rem .75rem; line-height: 1.4; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,.15); }
    .legend .item { display: flex; align-items: center; margin-bottom: 4px; }
    .legend .swatch { width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; border: 1px solid #8884; }
    .pill { display:inline-block; padding:2px 6px; border-radius:12px; background:#eee; font-size:12px; margin:2px 4px 0 0; }
    select, input { padding: .35rem .5rem; border: 1px solid #bbb; border-radius: 6px; }
    .attribution { font-size: 12px; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div>
      <label for="statusFilter"><strong>Status</strong></label><br />
      <select id="statusFilter"><option value="">All</option></select>
    </div>
    <div>
      <label for="categoryFilter"><strong>Category</strong></label><br />
      <select id="categoryFilter"><option value="">All</option></select>
    </div>
    <div>
      <label for="search"><strong>Search company</strong></label><br />
      <input id="search" type="search" placeholder="Type to filter…" />
    </div>
    <div>
      <label><strong>Layers</strong></label><br />
      <label><input type="checkbox" id="toggleChoropleth" /> State choropleth</label>
    </div>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   late config (status colors, geo URLs, fallback coords) -->
  ./data.template.js</script>
  <!-- Optional stub (not required, but you asked for it) -->
  ./data.js</script>

  <script>
    // ---------------- Leaflet base map ----------------
    const map = L.map('map', { center: [22.9, 78.8], zoom: 5 });

    // OpenStreetMap standard tiles (with proper attribution)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; https://www.openstreetmap.org/copyrightOpenStreetMap</a> contributors',
    }).addTo(map); // OSM tiles + attribution are required by ODbL guidelines. [3](https://leafletjs.com/examples/quick-start/)[4](https://osmfoundation.org/wiki/Licence/Attribution_Guidelines)

    // ---------------- Config from template ----------------
    const STATUS_COLORS = window.STATUS_COLORS || { 'Unknown': '#9e9e9e' };
    const GEO_SOURCES = window.GEO_SOURCES || {};
    const CITY_FALLBACK = window.CITY_COORDS || {}; // { "City": [lat, lon, state] }

    // ---------------- City index (lat/lon + state) ----------------
    const norm = s => (s || '').toLowerCase().replace(/\s+/g, '');

    const cityIndex = new Map();
    let cityIndexReady = false;

    async function loadCityIndex() {
      try {
        const r = await fetch('./assets/in-cities.json'); // recommended file (MIT subset from Simplemaps)
        if (!r.ok) throw new Error('missing in-cities.json');
        const payload = await r.json();
        const list = Array.isArray(payload) ? payload : (payload.cities || []);
        list.forEach(c => {
          cityIndex.set(norm(c.city), { lat: +c.lat, lon: +c.lng, state: c.admin_name });
        });
        cityIndexReady = true;
      } catch (e) {
        console.warn('City index not found. Using fallback CITY_COORDS.', e);
        Object.entries(CITY_FALLBACK).forEach(([city, arr]) => {
          cityIndex.set(norm(city), { lat: +arr[0], lon: +arr[1], state: arr[2] || null });
        });
        cityIndexReady = cityIndex.size > 0;
      }
    }

    function resolveCity(name) { return cityIndex.get(norm(name)); }

    // ---------------- Read Excel directly (SheetJS) ----------------
    // We fetch dataset.xlsx from the same repo and parse the first sheet.
    async function loadExcelRows() {
      const resp = await fetch('./dataset.xlsx'); // Pages serves static files; fetch as ArrayBuffer
      if (!resp.ok) throw new Error('Failed to fetch dataset.xlsx');
      const buf = await resp.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' }); // parse workbook bytes in-browser. [1](https://docs.sheetjs.com/docs/getting-started/examples/import/)[2](https://docs.sheetjs.com/docs/solutions/input/)
      const firstSheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[firstSheetName];
      // Expect headers matching: City, Company Name, Category, Status, PoC, GP Team
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: null, raw: true });
      return rows.map(r => ({
        city: r['City'] ?? null,
        company: r['Company Name'] ?? null,
        category: r['Category'] ?? null,
        status: r['Status'] ?? null,
        poc: r['PoC'] ?? null,
        gp_team: r['GP Team'] ?? null
      }));
    }

    // ---------------- UI + layers ----------------
    const statusFilterEl = document.getElementById('statusFilter');
    const categoryFilterEl = document.getElementById('categoryFilter');
    const searchEl = document.getElementById('search');
    const toggleChoroplethEl = document.getElementById('toggleChoropleth');

    const markersLayer = L.layerGroup().addTo(map);
    let choroplethLayer = null;

    function statusColor(s) { return STATUS_COLORS[s] || STATUS_COLORS['Unknown'] || '#888'; }

    function companyPopup(r, coord) {
      return `
        <div style="min-width:220px">
          <div><strong>${r.company || '—'}</strong></div>
          <div>
            <span class="pill">${r.category || '—'}</span>
            <span class="pill" style="background:${statusColor(r.status)};color:white;">${r.status || 'Unknown'}</span>
          </div>
          <div>${r.city || ''}${coord?.state ? ', ' + coord.state : ''}</div>
          ${r.poc ? `<div>PoC: ${r.poc}</div>` : '' }
          ${r.gp_team ? `<div>GP Team: ${r.gp_team}</div>` : '' }
        </div>
      `;
    }

    function populateFilters(rows) {
      const statuses = new Set(), categories = new Set();
      rows.forEach(r => { if (r.status) statuses.add(r.status); if (r.category) categories.add(r.category); });
      Array.from(statuses).sort().forEach(s => {
        const opt = document.createElement('option'); opt.value = s; opt.textContent = s; statusFilterEl.appendChild(opt);
      });
      Array.from(categories).sort().forEach(c => {
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; categoryFilterEl.appendChild(opt);
      });
    }

    function renderMarkers(rows) {
      markersLayer.clearLayers();
      const statusFilter = statusFilterEl.value;
      const categoryFilter = categoryFilterEl.value;
      const q = searchEl.value.trim().toLowerCase();

      let missing = 0, plotted = 0;
      rows.forEach(r => {
        if (statusFilter && r.status !== statusFilter) return;
        if (categoryFilter && r.category !== categoryFilter) return;
        if (q && !(r.company || '').toLowerCase().includes(q)) return;

        const coord = resolveCity(r.city);
        if (!coord) { missing++; return; }

        const m = L.circleMarker([coord.lat, coord.lon], {
          radius: 6, color: statusColor(r.status),
          fillColor: statusColor(r.status), fillOpacity: 0.85, weight: 1
        }).bindPopup(companyPopup(r, coord));
        markersLayer.addLayer(m);
        plotted++;
      });

      console.info(`Plotted: ${plotted}, missing coords: ${missing}`);
    }

    async function renderChoropleth(rows, toggleOn) {
      if (choroplethLayer) { map.removeLayer(choroplethLayer); choroplethLayer = null; }
      if (!toggleOn) return;
      if (!cityIndexReady) { console.warn('No city index; choropleth needs states.'); return; }

      const url = (GEO_SOURCES && GEO_SOURCES.INDIA_STATES_GEOJSON_URL)
        || 'https://raw.githubusercontent.com/india-in-data/india_maps/master/india_state_ut_administered.geojson';
      const gj = await fetch(url).then(r => r.json()); // public India states GeoJSON. [5](https://github.com/india-in-data/india_maps)

      const counts = new Map();
      rows.forEach(r => {
        const st = resolveCity(r.city)?.state;
        if (!st) return;
        counts.set(st, (counts.get(st) || 0) + 1);
      });

      const nrm = s => (s || '').toLowerCase();
      const getCount = f => {
        const name = f.properties?.name || f.properties?.st_nm || f.properties?.NAME_1;
        if (!name) return 0;
        const exact = counts.get(name); if (exact) return exact;
        const lo = nrm(name);
        const found = Array.from(counts.entries()).find(([k]) => nrm(k) === lo);
        return found ? found[1] : 0;
      };

      const ramp = c => c === 0 ? '#efefef' : c < 2 ? '#c5e1a5' : c < 5 ? '#81c784' : c < 10 ? '#4caf50' : '#2e7d32';

      choroplethLayer = L.geoJSON(gj, {
        style: f => { const c = getCount(f); return { weight: 1, color: '#666', fillColor: ramp(c), fillOpacity: .6 }; },
        onEachFeature: (f, layer) => {
          const nm = f.properties?.name || f.properties?.st_nm || f.properties?.NAME_1 || 'State';
          const c = getCount(f);
          layer.bindPopup(`<strong>${nm}</strong><br/>Companies: ${c}`);
        }
      }).addTo(map);
    }

    // Legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `<div><strong>Status legend</strong></div>`;
      Object.entries(STATUS_COLORS).forEach(([label, clr]) => {
        const item = document.createElement('div'); item.className = 'item';
        item.innerHTML = `<span class="swatch" style="background:${clr}"></span>${label}`;
        div.appendChild(item);
      });
      div.innerHTML += `<div class="attribution" style="margin-top:.5rem;">Basemap: © OpenStreetMap contributors</div>`;
      return div;
    };
    legend.addTo(map);

    // Wire events
    toggleChoroplethEl.addEventListener('change', async e => {
      const rows = window.__DATA_ROWS_CACHE || [];
      await renderChoropleth(rows, e.target.checked);
    });
    statusFilterEl.addEventListener('change', () => renderMarkers(window.__DATA_ROWS_CACHE || []));
    categoryFilterEl.addEventListener('change', () => renderMarkers(window.__DATA_ROWS_CACHE || []));
    searchEl.addEventListener('input', () => renderMarkers(window.__DATA_ROWS_CACHE || []));

    // Init
    (async function init() {
      await loadCityIndex(); // load coords
      const rows = await loadExcelRows(); // parse Excel in browser via SheetJS. [1](https://docs.sheetjs.com/docs/getting-started/examples/import/)
      window.__DATA_ROWS_CACHE = rows;
      populateFilters(rows);
      renderMarkers(rows);
    })();
  </script>
</body>
</html>
