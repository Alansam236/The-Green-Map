
<!DOCTYPE html>
<html>
<head>
  <title>India Company Map</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">

  <!-- Strict Content Security Policy -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 style-src 'self';
                 script-src 'self';
                 img-src * data:;
                 connect-src https://nominatim.openstreetmap.org https://{s}.tile.openstreetmap.org https://tile.openstreetmap.org;
                 font-src 'self';">

  <!-- Local Leaflet (no CDN) -->
  <link rel="stylesheet" href="assets/leaflet/leaflet.js</script>

  <style>
    body,html { margin:0; height:100%; }
    #map { height:100%; width:100%; }
    .controls {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:#fff; padding:12px; border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.3); width:360px;
      font-size:13px; max-height:90vh; overflow:auto;
    }
    .controls .row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .controls .row label { flex:0 0 120px; font-weight:600; }
    .controls .row select, .controls .row input { flex:1; }
    .legend .row { display:flex; align-items:center; gap:8px; margin-bottom:5px; }
    .dot { width:14px; height:14px; border-radius:50%; display:inline-block; border:1px solid #3332; }
    .badge { margin-left:auto; background:#eef3ff; color:#1f3b99; border:1px solid #cdd6ff; border-radius:10px; padding:2px 8px; font-size:12px; min-width:24px; text-align:center; }
    #counts { margin-top:8px; }
    #resetBtn { margin-top:4px; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
  <!-- Search boxes -->
  <div class="row"><label>Search City</label>    <input type="text" id="searchCity" placeholder="e.g., Hyderabad"></div>
  <div class="row"><label>Search Company</label> <input type="text" id="searchCompany" placeholder="e.g., Ultratech"></div>

  <!-- Dropdown filters -->
  <div class="row"><label>Status</label>   <select id="filterStatus"><option value="__all__">All</option></select></div>
  <div class="row"><label>Category</label> <select id="filterCategory"><option value="__all__">All</option></select></div>
  <div class="row"><label>City</label>     <select id="filterCity"><option value="__all__">All</option></select></div>
  <div class="row"><label>State</label>    <select id="filterState"><option value="__all__">All</option></select></div>
  <div class="row"><label>Company</label>  <select id="filterCompany"><option value="__all__">All</option></select></div>
  <div class="row"><label>Year</label>     <select id="filterYear"><option value="__all__">All</option></select></div>
  <div class="row"><label>PoC</label>      <select id="filterPoC"><option value="__all__">All</option></select></div>
  <div class="row"><label>GP Team2</label> <select id="filterGP"><option value="__all__">All</option></select></div>

  <button id="resetBtn">Reset</button>
  <div id="counts"></div>

  <div id="legend" class="legend" style="margin-top:8px;">
    <b>Status Legend</b>
  </div>
</div>

<!-- Built by GitHub Actions into gh-pages -->
data.js</script>

<script>
const initialCenter = [22.9734, 78.6569]; // India
const initialZoom   = 5;

// Default OSM tiles (works behind most corporate networks)
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
});
const map = L.map("map", { center: initialCenter, zoom: initialZoom, layers: [osm] });

// Utilities
function sleep(ms){ return new Promise(r => setTimeout(r,ms)); }
function escapeHtml(s){
  return String(s||"").replace(/[&<>\"']/g, c => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
  ));
}
function uniqueSorted(values){
  return Array.from(new Set(values.filter(v => v !== "" && v !== null && v !== undefined)))
              .map(v => String(v))
              .sort((a,b)=> a.localeCompare(b, undefined, {sensitivity: "base"}));
}
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const get = (row, names) => { for (const n of names) if (n in row) return row[n]; return ""; };

(async function(){
  const rows = Array.isArray(window.DATA_ROWS) ? window.DATA_ROWS : [];

  const allCities    = uniqueSorted(rows.map(r => get(r, ["City"])));
  const allStates    = uniqueSorted(rows.map(r => get(r, ["State"])));
  const allCompanies = uniqueSorted(rows.map(r => get(r, ["Company Name","Company"])));
  const allCats      = uniqueSorted(rows.map(r => get(r, ["Category"])));
  const allStatuses  = uniqueSorted(rows.map(r => get(r, ["Status"])));
  const allYears     = uniqueSorted(rows.map(r => get(r, ["Year of Certification","Year","Certification Year"])));
  const allPoCs      = uniqueSorted(rows.map(r => get(r, ["PoC","POC"])));
  const allGPs       = uniqueSorted(rows.map(r => get(r, ["GP Team2","GreenPro Vertical","GP Team","Vertical"])));

  const statusSel  = document.getElementById("filterStatus");
  const catSel     = document.getElementById("filterCategory");
  const citySel    = document.getElementById("filterCity");
  const stateSel   = document.getElementById("filterState");
  const compSel    = document.getElementById("filterCompany");
  const yearSel    = document.getElementById("filterYear");
  const pocSel     = document.getElementById("filterPoC");
  const gpSel      = document.getElementById("filterGP");
  const searchCityInput    = document.getElementById("searchCity");
  const searchCompanyInput = document.getElementById("searchCompany");

  function addOptions(sel, arr){
    arr.forEach(v => { const o = document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
  }
  addOptions(statusSel,  allStatuses);
  addOptions(catSel,     allCats);
  addOptions(citySel,    allCities);
  addOptions(stateSel,   allStates);
  addOptions(compSel,    allCompanies);
  addOptions(yearSel,    allYears);
  addOptions(pocSel,     allPoCs);
  addOptions(gpSel,      allGPs);

  // Legend with live counts
  const legend = document.getElementById("legend");
  const legendMap = {};
  allStatuses.forEach(st => {
    const r = document.createElement("div"); r.className="row";
    const d = document.createElement("span"); d.className="dot";
    d.style.background = (typeof statusColors !== "undefined" && statusColors[st]) ? statusColors[st] : (typeof defaultStatusColor !== "undefined" ? defaultStatusColor : "#607d8b");
    const label = document.createTextNode(st);
    const countSpan = document.createElement("span"); countSpan.className="badge"; countSpan.textContent = "0";
    r.appendChild(d); r.appendChild(label); r.appendChild(countSpan); legend.appendChild(r);
    legendMap[st] = { count: countSpan };
  });

  const group   = L.layerGroup().addTo(map);
  const markers = [];
  for (const r of rows){
    const city     = get(r, ["City"]).trim();
    const state    = get(r, ["State"]).trim();
    const company  = get(r, ["Company Name","Company"]).trim() || "Unknown Company";
    const category = get(r, ["Category"]).trim();
    const status   = get(r, ["Status"]).trim();
    const year     = get(r, ["Year of Certification","Year","Certification Year"]).toString().trim();
    const poc      = get(r, ["PoC","POC"]).trim();
    const gp       = get(r, ["GP Team2","GreenPro Vertical","GP Team","Vertical"]).trim();
    if (!city) continue;

    const key = (city + (state ? (", " + state) : ", India")).toLowerCase();
    let coords = null;
    if (typeof geo_lookup !== "undefined" && geo_lookup[key]) coords = geo_lookup[key];
    if (!coords){
      try { const cached = localStorage.getItem("geo:"+key); if (cached) coords = JSON.parse(cached); } catch {}
    }
    if (!coords){
      const query = encodeURIComponent(city + (state ? (", " + state) : ", India"));
      const url = `https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`;
      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        const j   = await res.json();
        if (Array.isArray(j) && j.length > 0){
          coords = { lat: +j[0].lat, lng: +j[0].lon };
          try { localStorage.setItem("geo:"+key, JSON.stringify(coords)); } catch {}
        }
      } catch(e) {}
      await sleep(1100);
    }
    if (!coords) continue;

    const fill = (typeof statusColors !== "undefined" && statusColors[status]) ? statusColors[status] : (typeof defaultStatusColor !== "undefined" ? defaultStatusColor : "#607d8b");
    const marker = L.circleMarker([coords.lat, coords.lng], { radius: 7, fillColor: fill, fillOpacity: 0.95, stroke: false });
    marker.meta = { city, state, company, category, status, year, poc, gp };
    marker.bindPopup(
      `<b>${escapeHtml(company)}</b><br>` +
      `${escapeHtml(category)}<br>` +
      `${escapeHtml(city)}${state ? (', ' + escapeHtml(state)) : ""}<br>` +
      `<b>Status:</b> ${escapeHtml(status)}<br>` +
      `<b>Year:</b> ${escapeHtml(year)}<br>` +
      `<b>PoC:</b> ${escapeHtml(poc)}<br>` +
      `<b>GP Team2:</b> ${escapeHtml(gp)}`
    );
    marker.addTo(group);
    markers.push(marker);
  }

  const counts = document.getElementById("counts");
  function applyFilters(){
    const sVal  = statusSel.value, cVal  = catSel.value, ciVal = citySel.value, stVal = stateSel.value;
    const coVal = compSel.value,   yVal  = yearSel.value, pVal  = pocSel.value, gVal  = gpSel.value;
    const searchCity    = searchCityInput.value.trim().toLowerCase();
    const searchCompany = searchCompanyInput.value.trim().toLowerCase();

    let shown = 0; const statusCounts = {};
    markers.forEach(m => {
      const matchesDropdown =
        (sVal === "__all__" || m.meta.status   === sVal) &&
        (cVal === "__all__" || m.meta.category === cVal) &&
        (ciVal=== "__all__" || m.meta.city     === ciVal) &&
        (stVal=== "__all__" || m.meta.state    === stVal) &&
        (coVal=== "__all__" || m.meta.company  === coVal) &&
        (yVal === "__all__" || m.meta.year     === yVal) &&
        (pVal === "__all__" || m.meta.poc      === pVal) &&
        (gVal === "__all__" || m.meta.gp       === gVal);

      const matchesSearch =
        (searchCity === ""    || m.meta.city.toLowerCase().includes(searchCity)) &&
        (searchCompany === "" || m.meta.company.toLowerCase().includes(searchCompany));

      const ok = matchesDropdown && matchesSearch;
      if (ok){
        if (!map.hasLayer(m)) m.addTo(group);
        shown++; const st = m.meta.status || ""; statusCounts[st] = (statusCounts[st] || 0) + 1;
      } else { if (map.hasLayer(m)) group.removeLayer(m); }
    });

    counts.innerHTML = `Total plotted: <b>${markers.length}</b> â€” showing <b>${shown}</b>`;
    Object.keys(legendMap).forEach(st => { legendMap[st].count.textContent = statusCounts[st] ? String(statusCounts[st]) : "0"; });
  }

  [statusSel, catSel, citySel, stateSel, compSel, yearSel, pocSel, gpSel].forEach(sel => sel.onchange = applyFilters);
  const debouncedSearch = debounce(applyFilters, 200);
  searchCityInput.addEventListener("input", debouncedSearch);
  searchCompanyInput.addEventListener("input", debouncedSearch);

  document.getElementById("resetBtn").onclick = () => {
    map.setView(initialCenter, initialZoom);
    [statusSel, catSel, citySel, stateSel, compSel, yearSel, pocSel, gpSel].forEach(sel => sel.value = "__all__");
    searchCityInput.value = ""; searchCompanyInput.value = ""; applyFilters();
  };
  applyFilters();
})();
</script>
</body>
</html>
